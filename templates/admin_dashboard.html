<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - AyurSutra</title>

<!-- Fonts & Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* =============== RESET =============== */
* { margin:0; padding:0; box-sizing:border-box; }

/* =============== BODY =============== */
body {
  font-family: 'Nunito Sans', sans-serif;
  background: linear-gradient(135deg, #6A11CB 0%, #2575FC 50%, #00C9A7 100%);
  color: #222;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  overflow-x:hidden;
}

/* =============== HEADER =============== */
header {
  width: 100%;
  padding: 50px 0 40px;
  background: linear-gradient(90deg, rgba(106,17,203,0.9), rgba(37,117,252,0.9));
  color: #f9fbff;
  text-align:center;
  font-size:38px;
  font-weight:700;
  font-family:'Poppins', sans-serif;
  letter-spacing:1.2px;
  box-shadow:0 4px 30px rgba(0,0,0,0.25);
  border-bottom-left-radius:40px;
  border-bottom-right-radius:40px;
  text-shadow:1px 1px 8px rgba(0,0,0,0.25);
}

/* =============== NAVBAR =============== */
.navbar {
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  border-radius: 0 0 30px 30px;
  padding: 18px 0;
  position: sticky;
  top:0;
  z-index:100;
}
.navbar a {
  text-decoration:none;
  margin:0 25px;
  font-weight:600;
  color:#f1f6ff;
  font-family:'Poppins', sans-serif;
  transition:0.3s;
  font-size:16px;
  position:relative;
}
.navbar a::after {
  content:'';
  display:block;
  width:0%;
  height:3px;
  background:#00C9A7;
  transition: width 0.3s;
  border-radius:2px;
  margin-top:3px;
}
.navbar a:hover { color:#00f5d4; }
.navbar a:hover::after { width:100%; }

/* =============== MAIN =============== */
main {
  flex:1;
  width:100%;
  max-width:1200px;
  margin:40px auto;
  padding:0 25px;
}

/* =============== TABLE CARDS (Matching Background) =============== */
.table-card {
  background: rgba(255,255,255,0.15);  /* semi-transparent */
  backdrop-filter: blur(20px);          /* blur for readability */
  border-radius:25px;
  padding:30px 25px;
  box-shadow:0 10px 30px rgba(0,0,0,0.15);
  margin-bottom:50px;
  transition:all 0.4s ease;
  color:#f1f6ff;  /* text color for readability */
}
.table-card h2 {
  font-family:'Poppins', sans-serif;
  text-align:center;
  font-size:26px;
  color:#f1f6ff;
  margin-bottom:25px;
  letter-spacing:0.5px;
}

/* =============== TABLES =============== */
table {
  width:100%;
  border-collapse: collapse;
  border-radius:15px;
  overflow:hidden;
}
th, td {
  padding:14px 20px;
  text-align:left;
  font-size:15px;
  transition:0.2s;
  color:#fff;  /* white text for readability */
}
th {
  background: rgba(37,117,252,0.8);
  font-weight:600;
}
tr {
  background: rgba(0,0,0,0.1);
  transition:0.3s;
}
tr:hover {
  background: rgba(0,201,167,0.2);
  transform: translateY(-2px);
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
}
.name-input {
  padding:6px 8px;
  border-radius:5px;
  border:1px solid #ccc;
  color:#000;
  width:90%;
}

/* =============== BUTTONS =============== */
.edit-btn, .save-btn, .delete-btn {
  padding:5px 12px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-weight:500;
  margin-left:5px;
  font-size:14px;
}
.edit-btn, .save-btn { background:#2575FC; color:white; }
.edit-btn:hover, .save-btn:hover { background:#6A11CB; }
.delete-btn { background:#c62828; color:white; }
.delete-btn:hover { background:#8e0000; }

/* =============== ADD BUTTON LINK =============== */
.btn {
  display:inline-block;
  margin-top:15px;
  padding:10px 25px;
  border-radius:50px;
  font-weight:600;
  color:white;
  background:linear-gradient(90deg,#00C9A7,#2575FC);
  text-decoration:none;
  transition:0.3s;
}
.btn:hover { background:linear-gradient(90deg,#6A11CB,#00C9A7); transform:translateY(-2px); }

/* =============== RESPONSIVE =============== */
@media(max-width:768px){
  .navbar a { margin:8px 12px; font-size:15px; }
  table { font-size:14px; }
  .table-card { padding:20px; }
}
</style>
</head>
<body>

<header>AyurSutra Admin Dashboard</header>

<nav class="navbar">
  <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
  <a href="{{ url_for('add_patient') }}">Add Patient</a>
  <a href="{{ url_for('add_therapist') }}">Add Therapist</a>
  <a href="{{ url_for('logout') }}">Logout</a>
</nav>

<main>
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash flash-{{ category }}" style="margin-bottom:15px;font-weight:600;color:#f1f6ff;">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Patients Table -->
  <div class="table-card">
    <h2>All Patients</h2>
    {% if patients %}
    <table>
      <thead>
        <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for p in patients %}
        <tr id="patient-{{ p.id }}">
          <td>
            <span class="name-text">{{ p.username }}</span>
            <input type="text" class="name-input" value="{{ p.username }}" style="display:none;">
          </td>
          <td>{{ p.role }}</td>
          <td>
            <button class="edit-btn" onclick="toggleEdit({{ p.id }})">Edit</button>
            <button class="save-btn" style="display:none;" onclick="saveName({{ p.id }}, 'patient')">Save</button>
            <form action="{{ url_for('delete_patient', user_id=p.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this patient?')">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>No patients registered.</p>{% endif %}
    <a class="btn" href="{{ url_for('add_patient') }}">Add New Patient</a>
  </div>

  <!-- Therapists Table -->
  <div class="table-card">
    <h2>All Therapists</h2>
    {% if therapists %}
    <table>
      <thead>
        <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for t in therapists %}
        <tr id="therapist-{{ t.id }}">
          <td>
            <span class="name-text">{{ t.username }}</span>
            <input type="text" class="name-input" value="{{ t.username }}" style="display:none;">
          </td>
          <td>{{ t.role }}</td>
          <td>
            <button class="edit-btn" onclick="toggleEdit({{ t.id }})">Edit</button>
            <button class="save-btn" style="display:none;" onclick="saveName({{ t.id }}, 'therapist')">Save</button>
            <form action="{{ url_for('delete_therapist', user_id=t.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this therapist?')">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>No therapists registered.</p>{% endif %}
    <a class="btn" href="{{ url_for('add_therapist') }}">Add New Therapist</a>
  </div>
</main>

<script>
function toggleEdit(id) {
  const row = document.getElementById(`patient-${id}`) || document.getElementById(`therapist-${id}`);
  const nameText = row.querySelector('.name-text');
  const nameInput = row.querySelector('.name-input');
  const editBtn = row.querySelector('.edit-btn');
  const saveBtn = row.querySelector('.save-btn');

  const isEditing = nameInput.style.display === 'inline-block';
  if (!isEditing) {
    nameText.style.display = 'none';
    nameInput.style.display = 'inline-block';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    nameInput.focus();
  }
}

function saveName(id, type) {
  const row = document.getElementById(`${type}-${id}`);
  const nameText = row.querySelector('.name-text');
  const nameInput = row.querySelector('.name-input');
  const editBtn = row.querySelector('.edit-btn');
  const saveBtn = row.querySelector('.save-btn');
  const newName = nameInput.value.trim();

  if (!newName) { alert('Name cannot be empty!'); return; }

  fetch(`/update_username/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: newName })
  })
  .then(res => res.json())
  .then(data => {
      if (data.status === 'success') {
          nameText.textContent = newName;
          nameText.style.display = 'inline';
          nameInput.style.display = 'none';
          editBtn.style.display = 'inline-block';
          saveBtn.style.display = 'none';
          alert('Username updated successfully!');
      } else { alert('Error: ' + data.message); }
  })
  .catch(err => alert('Network error.'));
}
</script>

</body>
</html>
